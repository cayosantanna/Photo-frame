<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PhotoFrame – Envio e Controles</title>
  <style>
    :root{--bg1:#f5f7fa;--bg2:#c3cfe2;--ink:#223;--muted:#556;--brand:#4A90E2;--ok:#27AE60;--warn:#F2994A;--card:#fff;}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));}
    .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:20px;}
    .card{background:var(--card);border-radius:18px;box-shadow:0 12px 34px rgba(0,0,0,.12);padding:22px;max-width:820px;width:100%;}
    .title{margin:0 0 6px;font-size:1.4rem;color:var(--ink);text-align:center}
    .subtitle{margin:0 0 14px;color:var(--muted);text-align:center}
    .filebox{margin:16px 0;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    input[type=file]{display:none;}
    .btn{display:inline-block;padding:12px 18px;border-radius:12px;background:var(--brand);color:#fff;font-weight:700;border:0;cursor:pointer}
    .btn.sec{background:#2D9CDB}
    .list{display:grid;gap:12px;margin-top:10px}
    .item{display:flex;align-items:center;gap:12px;background:#fafbff;border:1px solid #e6e9f2;border-radius:12px;padding:10px}
    .thumb{width:48px;height:48px;border-radius:8px;background:#eef;object-fit:cover}
    .meta{flex:1}
    .name{font-weight:600;color:var(--ink);font-size:.95rem}
    .status{color:var(--muted);font-size:.85rem}
    .bar{height:8px;background:#eef;border-radius:999px;overflow:hidden;margin-top:6px}
    .fill{height:100%;display:block;background:var(--ok);width:0}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width: 720px){.grid{grid-template-columns:1fr 1fr}}
    .panel{background:#f9fafc;border:1px solid #e6e9f2;border-radius:12px;padding:12px}
    .panel h3{margin:0 0 8px;color:#334}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .input{padding:10px;border-radius:10px;border:1px solid #dde}
    .small{font-size:.85rem;color:#667}
  </style>
</head>
<body>
  <div class="wrap"><div class="card">
    <h2 class="title">PhotoFrame – Enviar Arquivo</h2>
    <p class="subtitle">Selecione uma imagem (JPG/PNG) ou vídeo (MP4) até 100MB.</p>
    <div class="filebox">
      <label class="btn" for="file">Escolher arquivo(s)</label>
      <input id="file" type="file" accept="image/*,video/mp4" multiple/>
    </div>
    <div style="display:flex;gap:8px;justify-content:center">
      <button class="btn" onclick="send()">Enviar</button>
      <button class="btn sec" onclick="copyLink()">Copiar link</button>
    </div>
    <div class="grid">
      <div class="panel">
        <h3>Uploads</h3>
        <div class="list" id="list"></div>
        <p class="status" id="status"></p>
      </div>
      <div class="panel">
        <h3>Meus Arquivos</h3>
        <div class="row"><button class="btn sec" onclick="loadMyFiles()">Atualizar</button><span class="small">Apenas seus envios</span></div>
        <div class="list" id="mine"></div>
      </div>
      <div class="panel">
        <h3>Controles do Display</h3>
        <div class="row">
          <label><input type="checkbox" id="paused"> Pausar slideshow</label>
          <label>Intervalo (s): <input class="input" type="number" id="interval" min="1" max="600" value="10" style="width:90px"></label>
        </div>
        <div class="row">
          <label><input type="checkbox" id="loop"> Repetir vídeo (loop)</label>
          <label><input type="checkbox" id="videoPaused"> Pausar apenas o vídeo</label>
          <label><input type="checkbox" id="muted"> Sem som</label>
        </div>
        <div class="row">
          <label>Data: <input class="input" type="date" id="date"></label>
          <label>Forçar arquivo: <select class="input" id="forced"><option value="">(nenhum)</option></select></label>
          <button class="btn" onclick="applyControl()">Aplicar</button>
        </div>
        <div class="row">
          <button class="btn" id="btnPrev" onclick="prev()">◀ Anterior</button>
          <button class="btn" id="btnNext" onclick="next()">Próximo ▶</button>
        </div>
        <div class="small" id="ctrlStatus"></div>
      </div>
    </div>
  </div></div>

  <script>
    const f=document.getElementById('file');
    const list=document.getElementById('list');
    const s=document.getElementById('status');
    const mine=document.getElementById('mine');
    const paused=document.getElementById('paused');
    const interval=document.getElementById('interval');
    const date=document.getElementById('date');
    const forced=document.getElementById('forced');
  const ctrlStatus=document.getElementById('ctrlStatus');
  const btnPrev=document.getElementById('btnPrev');
  const btnNext=document.getElementById('btnNext');
    const loop=document.getElementById('loop');
  const videoPaused=document.getElementById('videoPaused');
  const muted=document.getElementById('muted');

    function readCookie(n){return (document.cookie.split('; ').find(r=>r.startsWith(n+'='))||'').split('=')[1]||'';}
    function writeCookie(n,v){document.cookie=n+'='+v+'; Max-Age='+(60*60*24*365)+'; Path=/; SameSite=Lax';}
    function getClientId(){
      let id=readCookie('pf-client-id')||localStorage.getItem('pf-client-id');
      if(!id){ id='web-'+Math.random().toString(36).slice(2,10); }
      if(!readCookie('pf-client-id')) writeCookie('pf-client-id',id);
      if(!localStorage.getItem('pf-client-id')) localStorage.setItem('pf-client-id',id);
      return id;
    }

    function addItem(file){
      const it=document.createElement('div'); it.className='item';
      const img=document.createElement(file.type.startsWith('image/')?'img':'div');
      img.className='thumb';
      if(img.tagName==='IMG'){img.src=URL.createObjectURL(file);} else {img.style.background='#dde'; img.textContent='MP4'; img.style.display='grid'; img.style.placeItems='center';}
      const meta=document.createElement('div'); meta.className='meta';
      const name=document.createElement('div'); name.className='name'; name.textContent=file.name;
      const st=document.createElement('div'); st.className='status'; st.textContent='Aguardando envio';
      const bar=document.createElement('div'); bar.className='bar'; const fill=document.createElement('span'); fill.className='fill'; bar.appendChild(fill);
      meta.appendChild(name); meta.appendChild(st); meta.appendChild(bar);
      it.appendChild(img); it.appendChild(meta); list.appendChild(it);
      return {it,st,fill};
    }

    function send(){
      if(!f.files.length){alert('Selecione arquivos');return;}
      const cid=getClientId(); s.textContent='Enviando '+f.files.length+' arquivo(s)...';
      const tasks=[...f.files].map(file=>new Promise(res=>{
        const u='/upload?filename='+encodeURIComponent(file.name)+'&clientId='+encodeURIComponent(cid);
        const req=new XMLHttpRequest(); req.open('POST',u,true); req.setRequestHeader('Content-Type','application/octet-stream');
        const ui=addItem(file);
        req.upload.onprogress=(ev)=>{if(ev.lengthComputable){ui.fill.style.width=Math.round(100*ev.loaded/ev.total)+'%';}};
        req.onreadystatechange=()=>{if(req.readyState===4){ui.st.textContent=(req.status===200?'Enviado':'Falhou')+': '+file.name; res();}};
        req.send(file);
      }));
      Promise.all(tasks).then(()=>{s.textContent='Concluído.'; loadMyFiles();});
    }

    function copyLink(){navigator.clipboard.writeText(window.location.href).then(()=>{s.textContent='Link copiado!';}).catch(()=>{alert('Não foi possível copiar.');});}
    function loadMyFiles(){ const cid=getClientId(); fetch('/myfiles?clientId='+encodeURIComponent(cid)).then(r=>r.json()).then(arr=>{ mine.innerHTML=''; arr.forEach(p=>{ const it=document.createElement('div'); it.className='item'; const icon = document.createElement(p.toLowerCase().endsWith('.mp4')?'div':'img'); icon.className='thumb'; if (icon.tagName==='IMG') { icon.src='/file?clientId='+encodeURIComponent(cid)+'&path='+encodeURIComponent(p); } else { icon.style.display='grid'; icon.style.placeItems='center'; icon.textContent='MP4'; } const meta=document.createElement('div'); meta.className='meta'; const name=document.createElement('div'); name.className='name'; name.textContent=p; const actions=document.createElement('div'); const del=document.createElement('button'); del.className='btn sec'; del.textContent='Excluir'; del.onclick=()=>delMine(p); actions.appendChild(del); meta.appendChild(name); meta.appendChild(actions); it.appendChild(icon); it.appendChild(meta); mine.appendChild(it); }); }); }
    function loadAllFiles(){ forced.innerHTML='<option value="">(nenhum)</option>'; fetch('/allfiles').then(r=>r.json()).then(arr=>{ arr.forEach(p=>{ const opt=document.createElement('option'); opt.value=p; opt.textContent=p; forced.appendChild(opt); }); }); }
    function delMine(p){ const cid=getClientId(); if(!confirm('Excluir '+p+'?')) return; fetch('/delete?clientId='+encodeURIComponent(cid)+'&path='+encodeURIComponent(p),{method:'POST'}).then(r=>r.text()).then(()=>loadMyFiles()); }
  function loadControl(){ fetch('/control').then(r=>r.json()).then(c=>{ paused.checked=!!c.paused; interval.value=Math.max(1, Math.round((c.interval||10000)/1000)); if (c.date) { const d=c.date.replaceAll('/','-').slice(0,10); date.value=d; } else { date.value=''; } forced.value=c.forced||''; loop.checked=!!c.loop; videoPaused.checked=!!c.videoPaused; muted.checked=!!c.muted; }); }
  function disableControls(dis){ btnPrev.disabled=dis; btnNext.disabled=dis; }
  function cooldown(){ disableControls(true); setTimeout(()=>disableControls(false), 300); }
  function applyControl(){ const ms=parseInt(interval.value||'10',10)*1000; const params=new URLSearchParams(); params.set('paused', paused.checked?'true':'false'); params.set('interval', String(ms)); const d=date.value; params.set('date', d?d:''); params.set('forced', forced.value||''); params.set('loop', loop.checked?'true':'false'); params.set('videoPaused', videoPaused.checked?'true':'false'); params.set('muted', muted.checked?'true':'false'); fetch('/control?'+params.toString(), {method:'POST'}).then(r=>{ if(r.status===429){ ctrlStatus.textContent='Aguarde um instante...'; } else { ctrlStatus.textContent='Aplicado.'; } cooldown(); setTimeout(()=>ctrlStatus.textContent='',2000);}); }
  function next(){ fetch('/next', {method:'POST'}).then(r=>{ ctrlStatus.textContent=(r.status===429?'Aguarde...':'Avançado.'); cooldown(); setTimeout(()=>ctrlStatus.textContent='',1500);}); }
  function prev(){ fetch('/previous', {method:'POST'}).then(r=>{ ctrlStatus.textContent=(r.status===429?'Aguarde...':'Recuado.'); cooldown(); setTimeout(()=>ctrlStatus.textContent='',1500);}); }

    loadMyFiles(); loadAllFiles(); loadControl();
  </script>
</body>
</html>
